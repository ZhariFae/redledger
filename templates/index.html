<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Mapúa University</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

    <div class="main-wrapper">
        
        <div class="brand-section">
            <div class="brand-circle"></div>
            <div class="brand-content">
                <div class="brand-title">THE RED<br>LEDGER</div>
                <div class="brand-subtitle">Mapúa University Library</div>
                <div class="brand-subtitle" style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">
                    Makati Campus
                </div>
            </div>
        </div>

        <div class="login-section">
            <div class="login-form-wrapper">
                
                <div class="text-center mb-4">
                    <div class="login-icon text-mapua">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <h3 class="fw-bold text-mapua text-uppercase" style="letter-spacing: 1px;">
                        Daily Log In
                    </h3>
                    <p class="text-muted small">Please enter your details below</p>
                </div>
                
                <div class="toggle-container">
                    <button class="toggle-btn active-student" id="btnStudent" type="button" onclick="showForm('student')">
                        <i class="bi bi-mortarboard-fill me-2"></i>Student
                    </button>
                    <button class="toggle-btn" id="btnGuest" type="button" onclick="showForm('guest')">
                        <i class="bi bi-person-badge-fill me-2"></i>Guest
                    </button>
                </div>

                <form id="loginForm">
                    
                    <input type="hidden" name="user_type" id="user_type" value="Student">
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="input-group-label">Last Name</label>
                            <input type="text" name="last_name" class="form-control" placeholder="Dela Cruz" required>
                        </div>
                        <div class="col-md-6">
                            <label class="input-group-label">First Name</label>
                            <input type="text" name="first_name" class="form-control" placeholder="Juan" required>
                        </div>
                    </div>

                    <div id="studentFields" class="fade-in">
                        <div class="mb-3">
                            <label class="input-group-label">Student Number</label>
                            <input type="text" name="id_number" class="form-control" 
                                   placeholder="2023XXXXXX" maxlength="10" pattern="\d{10}" 
                                   title="Must be 10 digits">
                        </div>

                        <div class="mb-4">
                            <label class="input-group-label">Program</label>
                            <select name="program" id="programSelect" class="form-select" placeholder="Search program...">
                                <option value="">Select Program...</option>
                                <option value="CS">Computer Science</option>
                                <option value="IT">Information Technology</option>
                                <option value="EMC">Entertainment and Multimedia Computing</option>
                                <option value="DS">Data Science</option>
                                <option value="IS">Information Systems</option>
                                <option value="NUR">Nursing</option>
                                <option value="APSY">AB Psychology</option>
                                <option value="BPSY">BS Psychology</option>
                                <option value="BIO">Biology</option>
                                <option value="MT">Medical Technology</option>
                                <option value="PHAR">Pharmacy</option>
                                <option value="PT">Physical Therapy</option>
                                <option value="RT">Radiologic Technology</option>
                                <option value="SHS">Senior High School</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div id="guestFields" class="d-none fade-in">
                        <div class="mb-4">
                            <label class="input-group-label">Agency / School</label>
                            <input type="text" name="agency" class="form-control" placeholder="Visitor, Parent, Alumni...">
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-login w-100 shadow-lg">
                        LOG IN
                    </button>
                </form>

                <div class="mt-4 text-center">
                    <a href="/admin_login" class="admin-link">
                        Administrator Access
                    </a>
                </div>

            </div>
        </div>
    </div>

    <script>
        // 1. Initialize TomSelect
        var programDropdown = new TomSelect("#programSelect", {
            create: false,
            sortField: { field: "text", direction: "asc" },
            dropdownParent: 'body'
        });

        // 2. Toggle Logic
        function showForm(type) {
            document.getElementById('user_type').value = (type === 'student') ? 'Student' : 'Guest';
            const sBtn = document.getElementById('btnStudent');
            const gBtn = document.getElementById('btnGuest');
            const sFields = document.getElementById('studentFields');
            const gFields = document.getElementById('guestFields');

            if (type === 'student') {
                sFields.classList.remove('d-none');
                gFields.classList.add('d-none');
                sBtn.className = "toggle-btn active-student";
                gBtn.className = "toggle-btn";
            } else {
                sFields.classList.add('d-none');
                gFields.classList.remove('d-none');
                gBtn.className = "toggle-btn active-guest";
                sBtn.className = "toggle-btn";
            }
        }

        // 3. AJAX SUBMISSION LOGIC
        const loginForm = document.getElementById('loginForm');
        const submitBtn = document.getElementById('submitBtn');

        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Stop the page from reloading
            
            // UI: Loading State
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Logging in...';
            submitBtn.disabled = true;

            // Gather Data
            const formData = new FormData(loginForm);

            try {
                // Send to Python
                const response = await fetch('/submit', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json(); // Read JSON response

                if (response.ok) {
                    // SUCCESS POPUP
                    Swal.fire({
                        title: 'Logged In!',
                        text: data.message,
                        icon: 'success',
                        footer: data.detail,
                        confirmButtonColor: '#9e1b32', // Mapúa Red
                        confirmButtonText: 'Great!',
                        timer: 3000,
                        timerProgressBar: true
                    });

                    // Clear Form
                    loginForm.reset();
                    programDropdown.clear(); // Reset TomSelect

                } else {
                    // ERROR POPUP (Validation failed)
                    Swal.fire({
                        title: 'Oops...',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#9e1b32'
                    });
                }

            } catch (error) {
                // NETWORK/SERVER ERROR
                Swal.fire({
                    title: 'System Error',
                    text: 'Could not connect to the server.',
                    icon: 'warning',
                    confirmButtonColor: '#9e1b32'
                });
            } finally {
                // Reset Button
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>